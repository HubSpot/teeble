/*! teeble - v0.1.0 - 2013-01-22
* https://github.com/hijonathan/teeble
* Copyright (c) 2013 HubSpot, Marc Neuwirth, Jonathan Kim; Licensed MIT */
(function(){this.Teeble={}}).call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};this.Teeble.TableRenderer=function(){function t(t){this.render_pagination=e(this.render_pagination,this),this.update_template=e(this.update_template,this),this.render_empty=e(this.render_empty,this),this.render_footer=e(this.render_footer,this),this.render_header=e(this.render_header,this),this.render_row=e(this.render_row,this),this.render_rows=e(this.render_rows,this),this.render=e(this.render,this),this.print_log=e(this.print_log,this),this._log_time=e(this._log_time,this),this._render=e(this._render,this),this._parse_data=e(this._parse_data,this),this._initialize=e(this._initialize,this),this._initialize(t),this}return t.prototype.debug=!1,t.prototype.log=[],t.prototype.key="rows",t.prototype.hasFooter=!1,t.prototype.data=null,t.prototype.header_template=null,t.prototype.row_template=null,t.prototype.rows_template=null,t.prototype.table_class=null,t.prototype.sortable_class="sorting",t.prototype.table_template=null,t.prototype.table_template_compiled=null,t.prototype.empty_message="No data to display",t.prototype._initialize=function(e){var t,n,r,i;this.start=Date.now(),this.options=e,n=["table_class","debug","key","partials","data","hasFooter","pagination_template","empty_message","cid"];for(r=0,i=n.length;r<i;r++)t=n[r],this.options[t]&&(this[t]=this.options[t]);this._log_time("start"),this.partials&&(this._log_time("generate partials"),this.update_template(this.partials));if(this.data)return this.render(this.data)},t.prototype._parse_data=function(e){var t,n;return e&&(Backbone&&e instanceof Backbone.Collection?(n={},n[this.key]=e.toJSON(),this.data=n):e[this.key]?this.data=e:e instanceof Array?(n={},e=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],Backbone&&t instanceof Backbone.Model?i.push(t.toJSON()):i.push(t);return i}(),n[this.key]=e,this.data=n):(n={},n[this.key]=[e],this.data=n)),this.data?!0:(console.log("could not parse data"),!1)},t.prototype._render=function(e,t){return t==null&&(t=this.data),e?t?(this._log_time("start compile"),this.rendered=e(t),this._log_time("end compile"),this.rendered):(console.log("no data"),!1):(console.log("no compiled template"),!1)},t.prototype._log_time=function(e){if(this.debug)return this.log.push(""+(Date.now()-this.start)+"ms: "+e)},t.prototype.print_log=function(){return console.log(this.log)},t.prototype.render=function(e){if(this._parse_data(e))return this._render(this.table_template_compiled)},t.prototype.render_rows=function(e){this.rows_template_compiled||(this.rows_template_compiled=Handlebars.compile(this.rows_template));if(this._parse_data(e))return this._render(this.rows_template_compiled)},t.prototype.render_row=function(e){this.row_template_compiled||(this.row_template_compiled=Handlebars.compile(this.row_template));if(e)return this._render(this.row_template_compiled,e)},t.prototype.render_header=function(e){debugger;this.header_template_compiled||(this.header_template_compiled=Handlebars.compile(this.header_template));if(e)return this._render(this.header_template_compiled,e)},t.prototype.render_footer=function(e){this.footer_template_compiled||(this.footer_template_compiled=Handlebars.compile(this.footer_template));if(e)return this._render(this.footer_template_compiled,e)},t.prototype.render_empty=function(e){this.table_empty_template_compiled||(this.table_empty_template_compiled=Handlebars.compile(this.table_empty_template));if(e)return e.message||(e.message=this.empty_message),this._render(this.table_empty_template_compiled,e)},t.prototype.update_template=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;this._log_time("generate master template"),s="",c="",n="",a=0;for(l in e){f=e[l];if(f.header){o="<th",f.header.attributes||(f.header.attributes={}),f.sortable&&(l&&(f.header.attributes["data-sort"]=l),f.header.attributes["class"]?(typeof f.header.attributes["class"]=="string"&&(f.header.attributes["class"]=[f.header.attributes["class"]]),f.header.attributes["class"].push(this.sortable_class)):f.header.attributes["class"]=[this.sortable_class]),v=f.header.attributes;for(t in v)d=v[t],d instanceof Array&&(d=d.join(" ")),o+=" "+t+'="'+d+'" ';f.header.template?(u=""+this.cid+"-header"+a,Handlebars.registerPartial(u,f.header.template),o+=">{{> "+u+" }}"):o+=">",o+="</th>",s+=o}if(f.footer){r="<td",f.footer.attributes||(f.footer.attributes={}),m=f.footer.attributes;for(t in m)d=m[t],d instanceof Array&&(d=d.join(" ")),r+=" "+t+'="'+d+'" ';f.footer.template?(i=""+this.cid+"-footer"+a,Handlebars.registerPartial(i,f.footer.template),r+=">{{> "+i+" }}"):r+=">",r+="</td>",n+=r}if(f.cell){h="<td",f.cell.attributes||(f.cell.attributes={}),f.sortable&&l&&(f.cell.attributes["data-sort"]=l),g=f.cell.attributes;for(t in g)d=g[t],d instanceof Array&&(d=d.join(" ")),h+=" "+t+'="'+d+'" ';f.cell.template?(p=""+this.cid+"-partial"+a,Handlebars.registerPartial(p,f.cell.template),h+=">{{> "+p+" }}"):h+=">",h+="</td>",c+=h}a++}return this.header_template="<tr>"+s+"</tr>",this.footer_template=n,this.row_template=c,this.rows_template="{{#each "+this.key+"}}<tr>"+this.row_template+"</tr>{{/each}}",this.table_empty_template='<td valign="top" colspan="'+a+'" class="teeble_empty">{{message}}</td>',this.table_template||(this.table_template='<table class="'+this.table_class+'">\n<thead>'+this.header_template+"</thead>\n<tbody>"+this.row_template+"</tbody>\n{{#if "+this.hasFooter+"}}\n<tfoot>"+this.footer_template+"<tfoot>\n{{/if}}\n</table>"),this.table_template_compiled=Handlebars.compile(this.table_template)},t.prototype.pagination_template_compiled=null,t.prototype.pagination_template='<div class="{{pagination_class}}">\n    <ul>\n        <li><a href="#" class="pagination-previous previous {{#if prev_disabled}}{{pagination_disabled}}{{/if}}">Previous</a></li>\n        {{#each pages}}\n        <li><a href="#" class="pagination-page {{#if active}}{{active}}{{/if}}" data-page="{{number}}">{{number}}</a></li>\n        {{/each}}\n        <li><a href="#" class="pagination-next next {{#if next_disabled}}{{pagination_disabled}}{{/if}}">Next</a></li>\n    </ul>\n</div>',t.prototype.render_pagination=function(e){return this.pagination_template_compiled||(this.pagination_template_compiled=Handlebars.compile(this.pagination_template)),this.pagination_template_compiled(e)},t}()}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.EmptyView=function(t){function r(){return this.render=e(this.render,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.initialize=function(){return this.renderer=this.options.renderer,this.collection.bind("destroy",this.remove,this)},r.prototype.render=function(){return this.renderer&&(this.el=this.renderer.render_empty(this.options)),this},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.FooterView=function(t){function r(){return this.render=e(this.render,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.tagName="tfoot",r.prototype.initialize=function(){return this.renderer=this.options.renderer,this.collection.bind("destroy",this.remove,this)},r.prototype.render=function(){return this.renderer&&this.$el.html(this.renderer.render_footer({})),this},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.HeaderView=function(t){function r(){return this.render=e(this.render,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.tagName="thead",r.prototype.initialize=function(){return this.renderer=this.options.renderer,this.collection.bind("destroy",this.remove,this)},r.prototype.render=function(){return this.renderer&&this.$el.html(this.renderer.render_header(this.options)),this},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.PaginationView=function(t){function r(){return this.render=e(this.render,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.tagName="div",r.prototype.initialize=function(){return this.renderer=this.options.renderer,this.collection.bind("destroy",this.remove,this)},r.prototype.render=function(){var e,t,n,r,i;return this.renderer&&(t=this.collection.info(),t.totalPages>1&&(i=function(){var e,i,s,o;s=t.pageSet,o=[];for(e=0,i=s.length;e<i;e++)r=s[e],n={active:r===t.currentPage?this.options.pagination.pagination_active:void 0,number:r},o.push(n);return o}.call(this),e={pagination_class:this.options.pagination.pagination_class,pagination_disabled:this.options.pagination.pagination_disabled,prev_disabled:t.previous===!1||t.hasPrevious===!1,next_disabled:t.next===!1||t.hasNext===!1,pages:i},this.$el.html(this.renderer.render_pagination(e)))),this},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.RowView=function(t){function r(){return this.render=e(this.render,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.tagName="tr",r.prototype.initialize=function(){return this.renderer=this.options.renderer,this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this)},r.prototype.render=function(){return this.renderer&&this.$el.html(this.renderer.render_row(this.model.toJSON({teeble:!0}))),this},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.TableView=function(t){function r(){return this.sortByDescending=e(this.sortByDescending,this),this.sortByAscending=e(this.sortByAscending,this),this._sort=e(this._sort,this),this.gotoPage=e(this.gotoPage,this),this.gotoLast=e(this.gotoLast,this),this.gotoNext=e(this.gotoNext,this),this.gotoPrev=e(this.gotoPrev,this),this.gotoFirst=e(this.gotoFirst,this),this.addOne=e(this.addOne,this),this.renderEmpty=e(this.renderEmpty,this),this.renderBody=e(this.renderBody,this),this.renderFooter=e(this.renderFooter,this),this.renderHeader=e(this.renderHeader,this),this.renderPagination=e(this.renderPagination,this),this.render=e(this.render,this),this.setOptions=e(this.setOptions,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.tagName="div",r.prototype.classes={sorting:{sortable_class:"sorting",sorted_desc_class:"sorting_desc",sorted_asc_class:"sorting_asc"},pagination:{pagination_class:"pagination",pagination_active:"active",pagination_disabled:"disabled"}},r.prototype.subviews={header:Teeble.HeaderView,row:Teeble.RowView,footer:Teeble.FooterView,pagination:Teeble.PaginationView,renderer:Teeble.TableRenderer,empty:Teeble.EmptyView},r.prototype.initialize=function(){return this.events=_.extend({},this.events,{"click a.first":"gotoFirst","click a.previous":"gotoPrev","click a.next":"gotoNext","click a.last":"gotoLast","click a.pagination-page":"gotoPage","click .sorting":"sortByAscending","click .sorting.sorting_asc":"sortByDescending","click .sorting.sorting_desc":"sortByAscending"}),this.setOptions(),r.__super__.initialize.apply(this,arguments),this.collection.on("add",this.addOne,this),this.collection.on("reset",this.renderBody,this),this.collection.on("reset",this.renderPagination,this),this.renderer=new this.subviews.renderer({partials:this.options.partials,table_class:this.options.table_class,cid:this.cid})},r.prototype.setOptions=function(){return this},r.prototype.render=function(){return this.$el.empty().append("<table><tbody></tbody></table"),this.table=this.$("table").addClass(this.options.table_class),this.body=this.$("tbody"),this.renderHeader(),this.renderBody(),this.renderFooter(),this.renderPagination(),this},r.prototype.renderPagination=function(){var e;if(this.options.pagination)return(e=this.pagination)!=null&&e.remove(),this.pagination=new this.subviews.pagination({renderer:this.renderer,collection:this.collection,pagination:this.classes.pagination}),this.$el.append(this.pagination.render().el)},r.prototype.renderHeader=function(){var e;return(e=this.header)!=null&&e.remove(),this.header=new this.subviews.header({renderer:this.renderer,collection:this.collection}),this.table.prepend(this.header.render().el)},r.prototype.renderFooter=function(){var e;if(this.options.footer){(e=this.footer)!=null&&e.remove();if(this.collection.length>0)return this.footer=new this.subviews.footer({renderer:this.renderer,collection:this.collection}),this.table.append(this.footer.render().el)}},r.prototype.renderBody=function(){return this.body.empty(),this.collection.length>0?this.collection.each(this.addOne):this.renderEmpty()},r.prototype.renderEmpty=function(){return this.empty=new this.subviews.empty({renderer:this.renderer,collection:this.collection}),this.body.append(this.empty.render().el)},r.prototype.addOne=function(e){var t;return t=new this.subviews.row({model:e,renderer:this.renderer}),this.body.append(t.render().el)},r.prototype.gotoFirst=function(e){return e.preventDefault(),this.collection.goTo(1)},r.prototype.gotoPrev=function(e){return e.preventDefault(),this.collection.previousPage()},r.prototype.gotoNext=function(e){return e.preventDefault(),this.collection.nextPage()},r.prototype.gotoLast=function(e){return e.preventDefault(),this.collection.goTo(this.collection.information.lastPage)},r.prototype.gotoPage=function(e){var t;return e.preventDefault(),t=this.$(e.target).text(),this.collection.goTo(t)},r.prototype._sort=function(e,t){var n,r;return e.preventDefault(),this.$el.find(".sorting").removeClass("sorting_desc sorting_asc"),n=this.$(e.target),n.hasClass("sorting")||(n=n.parents(".sorting")),n.addClass("sorting_"+t),r=n.attr("data-sort"),this.collection.setSort(r,t),this.collection.pager(),this.renderBody(),this.renderPagination()},r.prototype.sortByAscending=function(e){return this._sort(e,"asc")},r.prototype.sortByDescending=function(e){return this._sort(e,"desc")},r}(Backbone.View)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.ClientCollection=function(t){function r(){return this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.default_paginator_core={dataType:"json",url:function(){return this.url()}},r.prototype.default_paginator_ui={sortColumn:"",sortDirection:"desc",firstPage:1,currentPage:1,perPage:10,pagesInRange:3},r.prototype.initialize=function(){return this.paginator_ui=_.extend({},this.default_paginator_ui,this.paginator_ui),this.paginator_core=_.extend({},this.default_paginator_core,this.paginator_core),r.__super__.initialize.apply(this,arguments)},r}(Backbone.Paginator.clientPager)}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};this.Teeble.ServerCollection=function(t){function r(){return this.previousPage=e(this.previousPage,this),this.nextPage=e(this.nextPage,this),this.initialize=e(this.initialize,this),r.__super__.constructor.apply(this,arguments)}return n(r,t),r.prototype.default_paginator_core={dataType:"json",url:function(){return this.url()}},r.prototype.default_paginator_ui={firstPage:1,currentPage:1,perPage:10,pagesInRange:3},r.prototype.default_server_api={offset:function(){return(this.currentPage-1)*this.perPage},limit:function(){return this.perPage}},r.prototype.initialize=function(){return this.paginator_ui=_.extend({},this.default_paginator_ui,this.paginator_ui),this.paginator_core=_.extend({},this.default_paginator_core,this.paginator_core),this.server_api=_.extend({},this.default_server_api,this.server_api),r.__super__.initialize.apply(this,arguments)},r.prototype.nextPage=function(e){if(this.currentPage<this.information.totalPages)return this.promise=this.requestNextPage(e)},r.prototype.previousPage=function(e){if(this.currentPage>1)return this.promise=this.requestPreviousPage(e)},r}(Backbone.Paginator.requestPager)}.call(this);